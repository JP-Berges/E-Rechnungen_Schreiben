name: Build RechnungsTool fÃ¼r alle macOS Architekturen

on:
  push:
    tags: ['v*']     # Automatische Builds bei Version-Tags
    branches: [main] # Auch bei main-Branch pushes (fÃ¼r Development)
  pull_request:
    branches: [main] # Bei Pull Requests
  workflow_dispatch: # Manueller Trigger Ã¼ber GitHub UI

jobs:
  build-intel:
    name: "ğŸ–¥ï¸ Intel macOS Build (x86_64)"
    runs-on: macos-13  # Intel-basierter Runner
    
    steps:
    - name: "ğŸ“¥ Checkout Repository"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python 3.11"
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        architecture: 'x64'
        
    - name: "ğŸ“¦ Install Dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: "ğŸ”¨ Build Intel Binary"
      run: python build_rechnungstool.py
      
    - name: "ğŸ“‹ Collect Build Info"
      run: |
        echo "ğŸ—ï¸ Build Information" > build-info-intel.txt
        echo "===================" >> build-info-intel.txt
        echo "Architecture: $(uname -m)" >> build-info-intel.txt
        echo "Python Version: $(python --version)" >> build-info-intel.txt
        echo "macOS Version: $(sw_vers -productVersion)" >> build-info-intel.txt
        echo "Build Date: $(date)" >> build-info-intel.txt
        echo "" >> build-info-intel.txt
        echo "ğŸ“ Binary Info:" >> build-info-intel.txt
        file RechnungsTool_Distribution/RechnungsTool >> build-info-intel.txt
        echo "" >> build-info-intel.txt
        echo "ğŸ“¦ Directory Contents:" >> build-info-intel.txt
        ls -la RechnungsTool_Distribution/ >> build-info-intel.txt
        
    - name: "ğŸ“¦ Create Intel Distribution"
      run: |
        cd RechnungsTool_Distribution
        zip -r ../RechnungsTool-Intel-macOS.zip .
        
    - name: "â¬†ï¸ Upload Intel Artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: RechnungsTool-Intel
        path: |
          RechnungsTool-Intel-macOS.zip
          build-info-intel.txt

  build-apple-silicon:
    name: "ğŸš€ Apple Silicon Build (ARM64)"
    runs-on: macos-14  # Apple Silicon M1 Runner
    
    steps:
    - name: "ğŸ“¥ Checkout Repository"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python 3.11"
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        architecture: 'arm64'
        
    - name: "ğŸ“¦ Install Dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: "ğŸ”¨ Build Apple Silicon Binary"
      run: python build_apple_silicon.py
      
    - name: "ğŸ“‹ Collect Build Info"
      run: |
        echo "ğŸš€ Build Information" > build-info-silicon.txt
        echo "===================" >> build-info-silicon.txt
        echo "Architecture: $(uname -m)" >> build-info-silicon.txt
        echo "Python Version: $(python --version)" >> build-info-silicon.txt
        echo "macOS Version: $(sw_vers -productVersion)" >> build-info-silicon.txt
        echo "Build Date: $(date)" >> build-info-silicon.txt
        echo "" >> build-info-silicon.txt
        echo "ğŸ“ Binary Info:" >> build-info-silicon.txt
        file RechnungsTool_Distribution_ARM64/RechnungsTool >> build-info-silicon.txt
        echo "" >> build-info-silicon.txt
        echo "ğŸ“¦ Directory Contents:" >> build-info-silicon.txt
        ls -la RechnungsTool_Distribution_ARM64/ >> build-info-silicon.txt
        
    - name: "ğŸ“¦ Create Apple Silicon Distribution"
      run: |
        cd RechnungsTool_Distribution_ARM64
        zip -r ../RechnungsTool-AppleSilicon-macOS.zip .
        
    - name: "â¬†ï¸ Upload Apple Silicon Artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: RechnungsTool-AppleSilicon
        path: |
          RechnungsTool-AppleSilicon-macOS.zip
          build-info-silicon.txt

  create-release:
    name: "ğŸ‰ Create GitHub Release"
    needs: [build-intel, build-apple-silicon]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')  # Nur bei Version-Tags
    
    steps:
    - name: "ğŸ“¥ Checkout Repository"
      uses: actions/checkout@v4
      
    - name: "ğŸ“¦ Download Intel Build"
      uses: actions/download-artifact@v4
      with:
        name: RechnungsTool-Intel
        path: ./intel-build
        
    - name: "ğŸ“¦ Download Apple Silicon Build"
      uses: actions/download-artifact@v4
      with:
        name: RechnungsTool-AppleSilicon
        path: ./silicon-build
        
    - name: "ğŸ¯ Create GitHub Release"
      uses: softprops/action-gh-release@v1
      with:
        name: "RechnungsTool ${{ github.ref_name }}"
        body: |
          # ğŸ§¾ RechnungsTool ${{ github.ref_name }}
          
          **Professionelle deutsche Rechnungserstellung fÃ¼r macOS**
          
          ## ğŸ“¦ Downloads
          
          WÃ¤hlen Sie die passende Version fÃ¼r Ihren Mac:
          
          - **ğŸ–¥ï¸ Intel Macs** (x86_64) â†’ `RechnungsTool-Intel-macOS.zip`
          - **ğŸš€ Apple Silicon** (M1/M2/M3) â†’ `RechnungsTool-AppleSilicon-macOS.zip`
          
          > **ğŸ’¡ Tipp:** Intel-Version lÃ¤uft auch auf Apple Silicon (via Rosetta 2)
          
          ## ğŸš€ Installation
          
          1. Entsprechende ZIP-Datei herunterladen
          2. Entpacken durch Doppelklick
          3. `INSTALL_UND_STARTEN.sh` ausfÃ¼hren (oder direkt `RechnungsTool` starten)
          4. Bei macOS-Warnung: Rechtsklick â†’ "Ã–ffnen"
          
          ## âœ¨ Features
          
          - âœ… **PDF-Rechnungen** nach DIN 5008 Standard
          - âœ… **XRechnung-XML** fÃ¼r Ã¶ffentliche Auftraggeber
          - âœ… **Kleinunternehmer-Regelung** nach Â§ 19 UStG
          - âœ… **Automatische Rechnungsnummern** (YYYY-MM-DD-##)
          - âœ… **Logo-Integration** (logo.png)
          - âœ… **Deutsche Standards** (Â§Â§ 14, 14a UStG konform)
          
          ## ğŸ”§ Systemanforderungen
          
          - **macOS 10.13** (High Sierra) oder neuer
          - **~50 MB** freier Speicherplatz
          - Entsprechende **CPU-Architektur** (Intel oder Apple Silicon)
          
          ## ğŸ“ Support
          
          Bei Fragen oder Problemen: [GitHub Issues](https://github.com/JP-Berges/E-Rechnungen_Schreiben/issues)
          
          ---
          
          **Â© 2025 JP Engineering** | Made with â¤ï¸ in Germany
        files: |
          intel-build/RechnungsTool-Intel-macOS.zip
          silicon-build/RechnungsTool-AppleSilicon-macOS.zip
          intel-build/build-info-intel.txt
          silicon-build/build-info-silicon.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}